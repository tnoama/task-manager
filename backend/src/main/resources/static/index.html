<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Task Manager</title>
    <!-- script moved to end of body -->
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f7f7f7;
        margin: 0;
        padding: 0;
      }
      .main {
        display: flex;
        width: 100%;
        max-width: 1200px;
        min-width: 900px;
        margin: 40px auto;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        align-items: stretch;
      }
      .form-section {
        flex: 0 0 320px;
        padding: 32px 24px;
        border-right: 1px solid #eee;
        background: #fff;
      }
      .dashboard-section {
        flex: 1 1 0;
        padding: 32px 24px;
        background: #fff;
        min-width: 0;
      }
      h2 {
        margin-top: 0;
      }
      form {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      input,
      select,
      button {
        padding: 8px;
        font-size: 16px;
      }
      button {
        background: #2563eb;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      button:disabled {
        background: #ccc;
      }
      .dashboard-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 16px;
      }
      .dashboard-header input {
        flex: 1;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 8px;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
      }
      th {
        background: #f0f0f0;
      }
      .pagination {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 8px;
        margin-top: 12px;
      }
      .actions button {
        margin-right: 8px;
        background: #f59e42;
        color: #fff;
      }
      .actions button:last-child {
        background: #ef4444;
      }
    </style>
  </head>
  <body>
    <div class="main">
      <div class="form-section">
        <h2>Task Form</h2>
        <form id="taskForm">
          <label>Title</label>
          <input type="text" id="title" placeholder="Title" required />
          <label>Assignee</label>
          <input type="text" id="assignee" placeholder="Assignee" />
          <label>Description</label>
          <input type="text" id="description" placeholder="Description" />
          <label>Category</label>
          <select id="category" required>
            <option value="">Select Category</option>
            <option value="WORK">Work</option>
            <option value="PERSONAL">Personal</option>
            <option value="STUDY">Study</option>
            <option value="HEALTH">Health</option>
            <option value="OTHER">Other</option>
          </select>
          <label>Priority</label>
          <select id="priority" required>
            <option value="LOW">Low</option>
            <option value="MEDIUM">Medium</option>
            <option value="HIGH">High</option>
          </select>
          <label>Status</label>
          <select id="status" required>
            <option value="OPEN">Open</option>
            <option value="IN_PROGRESS">In Progress</option>
            <option value="DONE">Done</option>
          </select>
          <label>Due Date</label>
          <input
            type="date"
            id="dueDate"
            placeholder="Due Date"
            min=""
            required
          />
          <button type="submit">Submit</button>
        </form>
      </div>
      <div class="dashboard-section">
        <h2>Dashboard</h2>
        <div class="dashboard-header">
          <input type="text" id="search" placeholder="Search by assignee" />
          <select id="filterCategory">
            <option value="">All Categories</option>
            <option value="WORK">Work</option>
            <option value="PERSONAL">Personal</option>
            <option value="STUDY">Study</option>
            <option value="HEALTH">Health</option>
            <option value="OTHER">Other</option>
          </select>
          <select id="filterPriority">
            <option value="">All Priorities</option>
            <option value="LOW">Low</option>
            <option value="MEDIUM">Medium</option>
            <option value="HIGH">High</option>
          </select>
          <select id="filterStatus">
            <option value="">All Statuses</option>
            <option value="OPEN">Open</option>
            <option value="IN_PROGRESS">In Progress</option>
            <option value="DONE">Done</option>
          </select>
          <select id="sortBy">
            <option value="dueDate">Due Date</option>
            <option value="priority">Priority</option>
            <option value="category">Category</option>
            <option value="status">Status</option>
          </select>
          <select id="sortDir">
            <option value="asc">Ascending</option>
            <option value="desc">Descending</option>
          </select>
          <button id="filterBtn">Filter</button>
        </div>
        <table id="tasksTable">
          <thead>
            <tr>
              <th>Assignee</th>
              <th>Title</th>
              <th>Description</th>
              <th>Category</th>
              <th>Priority</th>
              <th>Status</th>
              <th>Due Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Tasks will be rendered here -->
          </tbody>
        </table>
        <div class="pagination">
          <button id="prevPage">&lt;</button>
          <span id="pageNum">1</span>
          <button id="nextPage">&gt;</button>
        </div>
      </div>
    </div>
  </body>
  <script>
    const API_URL = "http://localhost:8080/api/v1/tasks";
    let page = 0;
    let size = 5;
    let search = "";
    let tasksData = { content: [], totalPages: 1 };

    async function fetchTasks() {
      let url = `${API_URL}?page=${page}&size=${size}`;
      const category = document.getElementById("filterCategory").value;
      const priority = document.getElementById("filterPriority").value;
      const status = document.getElementById("filterStatus").value;
      const sortBy = document.getElementById("sortBy").value;
      const sortDir = document.getElementById("sortDir").value;
      if (search) url += `&assignee=${encodeURIComponent(search)}`;
      if (category && category !== "") url += `&category=${category}`;
      if (priority && priority !== "") url += `&priority=${priority}`;
      if (status && status !== "") url += `&status=${status}`;
      if (sortBy && sortBy !== "") url += `&sortBy=${sortBy}`;
      if (sortDir && sortDir !== "") url += `&sortDir=${sortDir}`;
      try {
        const res = await fetch(url);
        if (!res.ok) {
          const errorText = await res.text();
          alert("Error fetching tasks: " + errorText);
          console.error("Fetch tasks error:", errorText);
          return;
        }
        tasksData = await res.json();
        console.log("Fetched tasks:", tasksData);
        renderTasks(tasksData.content || []);
        renderPagination();
      } catch (err) {
        alert("Network or server error: " + err);
        console.error("Network/server error:", err);
      }
    }

    function renderTasks(tasks) {
      const tbody = document.querySelector("#tasksTable tbody");
      tbody.innerHTML = "";
      tasks.forEach((task) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${task.assignee || ""}</td>
            <td>${task.title || ""}</td>
            <td>${task.description || ""}</td>
            <td>${task.category || ""}</td>
            <td>${task.priority || ""}</td>
            <td>${task.status || ""}</td>
            <td>${task.dueDate || ""}</td>
            <td class="actions">
              <button onclick="markDone('${task.id}')">Done</button>
              <button onclick="deleteTask('${task.id}')">Delete</button>
            </td>
          `;
        tbody.appendChild(tr);
      });
    }

    function renderPagination() {
      document.getElementById("pageNum").textContent = page + 1;
      document.getElementById("prevPage").disabled = page === 0;
      document.getElementById("nextPage").disabled =
        page >= tasksData.totalPages - 1;
    }

    document
      .getElementById("taskForm")
      .addEventListener("submit", async function (e) {
        e.preventDefault();
        // ...existing code...
        const task = {
          title: document.getElementById("title").value,
          assignee: document.getElementById("assignee").value,
          description: document.getElementById("description").value,
          category: document.getElementById("category").value,
          priority: document.getElementById("priority").value,
          status: document.getElementById("status").value,
          dueDate: document.getElementById("dueDate").value,
        };
        try {
          const response = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(task),
          });
          if (!response.ok) {
            const errorText = await response.text();
            alert("Error: " + errorText);
            console.error("Task creation error:", errorText);
          } else {
            const result = await response.json();
            console.log("Task created:", result);
            e.target.reset();
            fetchTasks();
          }
        } catch (err) {
          alert("Network or server error: " + err);
          console.error("Network/server error:", err);
        }
      });

    document.getElementById("filterBtn").addEventListener("click", function () {
      search = document.getElementById("search").value;
      page = 0;
      // Always read all filter values and update the table
      fetchTasks();
    });

    document.getElementById("prevPage").addEventListener("click", function () {
      if (page > 0) {
        page--;
        fetchTasks();
      }
    });
    document.getElementById("nextPage").addEventListener("click", function () {
      if (page < tasksData.totalPages - 1) {
        page++;
        fetchTasks();
      }
    });

    async function deleteTask(id) {
      await fetch(`${API_URL}/${id}`, { method: "DELETE" });
      fetchTasks();
    }

    async function markDone(id) {
      await fetch(`${API_URL}/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status: "DONE" }),
      });
      fetchTasks();
    }

    window.deleteTask = deleteTask;
    window.markDone = markDone;

    window.onload = function () {
      // Set min date for dueDate input
      const today = new Date().toISOString().split("T")[0];
      document.getElementById("dueDate").setAttribute("min", today);
      fetchTasks();
    };

    // Auto-refresh on filter/sort change
    // Filtering only happens when Filter button is clicked
  </script>
</html>
